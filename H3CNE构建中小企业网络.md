## H3CNE构建中小企业网络

### 计算机网络的定义

计算机网络是一组自治计算机互联的集合

​	计算机：只要是能进行计算功能的机器，都是计算机，如手机，智能手表等

​	计算机粗暴定义：有CPU的机器都是计算机

​	自治计算机：有自我管理，自我治理功能的计算机

把自治计算机通过某种方式连接起来，这个集合就是一个计算机网络



### 计算机网络的基本功能

1.资源共享

​	比如：通过网络在优酷上下载电影

2.分布式处理与负载均衡

​	比如：多台服务器组成一个集群，同时处理任务

3.综合信息服务

​	通过网络向用户提供服务，比如：美团外卖，滴滴打车



### 计算机网络的分类

LAN：由用户自行建设，使用私有地址组建的内部网络

MAN：由运营商或大规模企业建设，连接城市范围的网络

WAN：

​	广义的WAN：LAN之外都是WAN

​	狭义的WAN：由运营商建设，连接各个城域网，又叫骨干网、传输网等



### 网络拓扑类型

拓扑定义：网络设备连接排列的方式

总线型拓扑：所有设备共享一条公共线路，线路中断则会导致所有设备通讯中断

环型拓扑：所有设备共享一条环形线路，传输性能稍微优于总线型拓扑

星型拓扑：其他节点与中央节点直接相连，某条线路中断不会影响其他节点，相较于总线型可靠性更高，中间节点故障会导致全网中断

树形拓扑：星型拓扑的进一步发散，结构简单，组网成本低，维护与管理容易；中央节点压力大，可靠性差

网状拓扑：可靠性高；环路问题，组网成本高，维护管理复杂



### 报文交换方式

电路交换：

​	基于电话网的电路交换，数据传输以专线的方式进行交换

​	优点：延迟小、透明传输

​	缺点：带宽固定、网络资源利用率低，初始连接建立慢

分组交换：

​	以分组为单位存储转发

​	优点：多路复用，网络资源利用率高

​	缺点：延迟大，实时性差，设备功能复杂

现在都采用分组交换



### 衡量计算机网络的主要指标

带宽：单位时间内能够传输的数据总量，单位：bps，带宽越大网络质量越好

延迟：数据从一个节点到另一个节点消耗的时间，单位：ms，延迟越低网络质量越好



### 协议和标准

协议：数据通信双方共同遵守的通讯规则

​	协议三要素：语法、语义、时序

标准：公认的，所有厂商所共同遵守的协议规则

标准化组织：

​	制定定义国际公认参考标准的组织团体

​	常见国际标准化组织：ISO（国际标准化组织）、IEEE（电子电气工程师协会）



### OSI参考模型

概念：定义了网络中设备所遵守的层次结构

优点：

​	开放的标准化接口，协议不再封闭

​	多厂商设备兼容

​	易于理解、学习和更新协议标准

​	实现模块化工程，降低开发难度

​	便于故障排除

分层：

​	应用层：为应用程序进程提供网络服务

​	表示层：定义数据格式、结构；数据加密、解密、压缩、解压缩

​	会话层：建立、维护、拆除应用程序的会话，区分同一个应用程序的不同访问者

​	传输层：数据分段，建立端到端连接、维护传输可靠性，端口可以用于区分同一台计算机上不同的应用程序

​		TCP：可靠的传输，适用于对数据完整性要求高，对延迟要求低的场景

​		UDP：不可靠的传输，适用于对延迟要求高，对数据完整性要求低的场景

​	网络层：IP地址寻址，路由

​	数据链路层：MAC地址寻址

​		LLC子层：逻辑链路控制，LLC子层负责识别网络层协议，然后对它们进行封装

​		MAC子层：介质访问控制，MAC子层的主要功能包括数据帧的封装/卸装，帧的寻址和识别，帧的接收与发送，链路的管理，帧的差错控制等

​	物理层：定义电压，接口，线缆标准，传输距离，传输介质等物理参数



TCP/IP参考模型

应用层

传输层

网络层

网络接口层



### 数据的封装与解封装

封装（自顶向下）：将数据变为比特流的过程中，在参考模型的每一层需要添加上特定的协议报头动作

解封装：封装的逆过程，数据从比特流还原为数据的过程



数据封装格式

​	传输层：数据段

​	网络层：数据包

​	数据链路层：数据帧

​	物理层：比特流

每个网络设备拆下层封装，查看本层封装



### 局域网基本原理

局域网的覆盖范围小，带宽高，通常用于建筑内部，园区范围内部的网络

众多局域网协议中，以太网占据着统治地位

局域网的主要协议：令牌环网（已淘汰）、FDDI（已淘汰）、以太网



以太网主要特征：

1.多路访问

2.使用双绞线或光纤连接



以太网典型设备：

集线器Hub：物理层设备，目前已经淘汰

​	Hub与主机构成物理星型拓扑，内部采用总线结构，任意时间只有一台主机能占用总线，传输效率低下



以太网线缆：同轴电缆、双绞线、光纤

双绞线最大传输距离100米



双绞线线序

​	T568A：绿白、绿、橙白、蓝、蓝白、橙、棕白、棕

​	T568B：橙白、橙、绿白、蓝、蓝白、绿、棕白、棕

​	其实双绞线内部只有四根线芯进行数据（1、3收和2、6发）

​	线序把一对线芯分开是为了防止传输数据时的电磁串扰



直连线：两端线序一致

交叉线：两端线序相反

接线原则：同类交叉，异类直连

注意：路由器和PC是同类设备（终端设备）

目前的设备都支持接口自适应，可以不分直连线和交叉线，但老设备上可能没有接口自适应功能



CSMA/CD

在以太网早期，Hub场景总线已经被占用的情况下，怎么确定自己能不能发送数据

先听后发，边听边发，冲突停发，延池重发



MAC地址为48位二进制数，采用12位16进制表示

前24位为OUI（厂商表识），后24位为EUI（设备标识）



以太网通讯类型：

单播：一对一

广播：一对所有（所有设备都能收到）

组播：一对多（只有特定设备才能收到）



交换机内部为网状结构

交换机隔离了冲突域，每个端口就是一个冲突域

提高以太网带宽利用率，实现精确的数据定向转发

适应不同的速率和双工



双工模式：

单工：只能发送数据，或者接收数据（如：收音机）

半双工：能发送和接收数据，但是不能同时发送和接收（如：对讲机）

全双工：能同时接收和发送数据



### 广域网基本原理

广域网连接方式：

专线方式

电路交换：

​	PSTN：电话拨号，带宽56Kbps

​	ISDN

分组交换：X.25/帧中继/ATM

现在不管是局域网还是广域网，以太网一统天下

EPON（以太网无源光网络）技术的出现，使得以太网可以使用光纤传输数据



### IP基本原理

早期网络层协议三架马车并驾齐驱，IP、IPX、Apple Talk，随着时代发展，IPX和Apple Talk都被淘汰了

IP的主要作用：

​	标识节点和链路：IP地址标识节点，IP网络号标识一个链路

​	寻址和转发：确定节点的网络位置，选择适当的路径将IP包转发到目的节点

​	适应各种数据链路：根据链路的MTU对IP包进行分片和重组

网段：路由器的每个接口肯定在不同网段；交换机上连接的所有设备都在一个网段（不划分VLAN的情况下）



IP头部格式：

​	Version：版本

​	IHL：头部长度，如果不标识头部长度，设备分不清头部是哪段，上层数据是哪段

​	Type of Service：服务类型，用来对IP数据包进行Qos

​	Total Length：总长度

​	Identification：标识符，同一个数据包切出来的所有分片，标识符都是一样的

​	Flags：标志，0x00代表不分片，是一个完整数据包；0x11代表分片，并不是一个完整数据包

​	Fragment Offset：分片偏移，对分片后的数据排序

​	Time to Live（TTL）：生存时间，数据包最多经过多少个路由器，用来防环

​	Protocol：标识上层协议号

​	Header Checksum：头部校验序列号，校验头部数据完整性

​	Source Address：源IP地址

​	Destination Address：目的IP地址

​	Options（可选）：选项

​	Padding（可选）：间隔

除开2个可选字段，其他头部字段一共20Byte



IP地址32位二进制，采用点分十进制的方式表示

网络号+主机号：网络位完全一致的IP地址属于同一网段

分类：

A类：1.x.x.x--126.x.x.x；第一段是网络位

B类：128.x.x.x--191.x.x.x；前两段是网络位

C类：192.x.x.x--223.x.x.x；前三段是网络位

D类：224.x.x.x--239.x.x.x（组播）

E类：240.x.x.x--（保留地址）

网络位的长度决定了本网段的规模



私有地址：

A类：10.x.x.x

B类：172.16.x.x--172.31.x.x

C类：192.168.x.x



特殊IP地址：

127.x.x.x；本地环回地址，用来测试本机TCP/IP协议是否工作正常

主机位全0的地址：本网段的网络地址，代表整个网段

主机位全1的地址：本网段的广播地址，网段内的所有设备

255.255.255.255：全网广播地址

0.0.0.0：任意IP地址



子网掩码：由连续的1或0构成，用来衡量IP地址的网络位长度，1对应网络位，0对应主机位

IP地址配置了子网掩码后，该IP地址就没有类的概念了



CIDR与VLSM

CIDR是把几个标准网络合成一个大的网络

VLSM是把一个标准网络分成几个小的子网



ARP协议

地址解析协议，把IP地址解析为MAC地址

1.以广播的形式发送ARP请求，查询目的IP对应的MAC地址

2.对方收到后，以单播的形式发送ARP响应，通告对方主机本机对的MAC地址

3.收到对方响应后，把目的IP与目的MAC的对应关系缓存到ARP缓存表中

代理ARP：可以跨网段解析MAC地址



主机单播IP包转发

上层协议要求发送数据包=>目的是否直连？

​	直连==>解析目的主机的MAC地址\==>封装成帧并有对应接口发出

​	非直连==>解析网关MAC地址\==>封装成帧并有对应接口发出



路由器单播IP包转发

数据包入站==>目的是否本机？

​	是==>提交本机上层协议处理

​	否==>目的是否直连？

​		是==>解析下一跳路由器MAC地址\==>封装成帧并有对应接口发出

​		否==>解析目的主机MAC地址\==>封装成帧并有对应接口发出

路由器默认不转发广播



ICMP协议

ping命令：可达性探测

tracert命令：路由跟踪



### 传输层协议基本原理

TCP

面向连接，维持端到端的连接状态，通过序列号和确认机制确保可靠传输，使用滑动窗口机制控制流量，对应用层数据分段封装，使用端口号标识上层程序



TCP可靠传输机制：

1.三次握手：建立可靠连接，SYN=1表示这是一个连接请求或连接接受请求

​	前两个包SYN=1，第三个包SYN=0

2.四次挥手：FIN=1表明此报文段的发送端的数据已经发送完毕，并要求释放连接

​	第一个包和第三个包FIN=1，四次挥手过程中第二个包和第三个包由被断开方发起

3.端口号：多路复用

4.完整性校验：差错校验

5.确认机制：ack应答

6.序列号：丢失检测、乱序重排

7.窗口机制：TCP的流量控制，这个值是接收端期望接收的字节数。窗口最大为65535字节



UDP

无连接，不维护连接状态，不确保可靠传输，没有流量控制，对应用层数据直接封装，使用端口号标识上层程序



在网络领域，可靠性和效率就是两个极端，正如鱼和熊掌不可兼得




路由器的作用：

连接具有不同介质的链路

连接网络或子网，隔离广播域

对数据报文执行寻路和转发

交换和维护路由信息



交换机的作用：

连接多个以太网物理段，隔离冲突域

对以太网帧进行高速而透明的交换转发

自行学习和维护MAC地址信息



路由器交换机的发展趋势

​	路由与交换技术的融合

​	多业务的融合

H3C路由器系列

​	CR系列核心路由器

​	SR系列高端路由器

​	MSR系列

​	ER系列

H3C交换机系列

​	数据中心系列

​	园区网络系列

​	EPON

​	EPCN网关



### H3C设备管理

H3C网络设备设备操作系统叫Comware，华为的叫VRP，思科的叫IOS

Console

telnet配置：

```
telnet server enable

local-user admin class manage
password simple 123456
service-type telnet
authorization-attribute user-role level-15
quit

user-interface vty 0 4
authentication-mode scheme
protocol inbound telnet
quit
```

ssh配置：

```
public-key local create
ssh server enable

local-user admin class manage
password simple 123456
service-type ssh
authorization-attribute user-role level-15
quit

user-interface vty 0 4
authentication-mode scheme
protocol inbound ssh
quit
```



### H3C设备文件管理

网络设备主要文件

​	启动软件包

​	配置文件

​	日志文件

网络设备存储：

​	ROM（固件）：存放启动程序

​	Flash：存放应用程序、起始配置文件、日志文件

​	RAM：运行中的操作系统、运行中的配置

文件操作需要在用户视图操作



FTP配置：

```
ftp server enable

local-user admin class manage
password simple 123456
service-type ftp
authorization-attribute user-role level-15
authonization-attribute work-directory flash:/
```



H3C升级操作系统步骤

1.上传软件到设备
2.解压软件
3.更新

```
install add flash:/X.IPE flash:/
boot-loader file boot flash:/X.bin system flash:/X.bin main
```



==H3C设备默认关闭tracert命令==

通过命令开启tracert

```
ip ttl-expires enable
ip unreachables enable
```



系统调试

```
terminal monltor //开启控制台对系统信息的监视
terminal debugging //打开调试信息的屏幕输出开关
debugging [module-name] //打开模块调试开关
display debugging //显示调试开关
undo debug all
```



### 以太网交换机工作原理

使用Hub连接的多台终端主机都处于同一个冲突域中，传输效率低下

网桥/交换机隔离冲突域，大大提升数据转发效率



交换机学习数据帧中的源MAC地址，写入MAC地址缓存表

交换机根据目的MAC地址进行转发

对于目的地址不识别的帧，交换机会进行泛洪

MAC地址表的老化时间是300秒



交换机收到帧的处理方式：

收到广播帧，直接广播发出

收到单播帧，查MAC地址表，如果有记录，则从对应端口发出

​	如果没有记录，则广播发出

广播是除了接收端口不发，其他端口都发



交换机的MAC地址表中，一个端口可以对应多个MAC地址，一个MAC地址不能对应多个端口（当一个MAC地址被多个端口学习到时，称为MAC地址漂移）

交换机默认不隔离广播域，路由器才隔离广播域，增加交换机的数量是在扩大广播域



### VLAN

当广播域大了之后，交换机之间不断广播会消耗大量设备性能，导致整个网络质量变低

采用路由器隔离广播域的组网方式，成本太高

VLAN用于二层网络隔离广播域

数据帧进入交换机，交换机会在帧的SMAC与Type之间，打上一个tag（标签）字段，该字段中会标明接收端口所属VLAN ID，通过VLAN ID标识不同的广播域，达到隔离广播域的目的

不同VLAN之间是不能二层通信的，MAC地址表除了记录MAC地址和端口，还会记录PVID

帧被打上标签后就不是一个标准的以太网帧，而被称之为802.1Q帧



交换机基于VLAN a口转发流程：

数据帧进入交换机，交换机为数据帧打上标签，标签中会记录PVID（接收端口所属的VLAN ID）

在MAC地址表中查询数据帧的目的地址对应的接口和所属VLAN；如果表中端口所属VLAN ID一致，则转发；如果不一致，则丢弃数据帧

交换机发出数据帧前，会撕掉帧中的标签



VLAN类型：

基于端口的VLAN（目前最常用）

基于MAC的VLAN：每个端口都是h口

基于子网的VLAN：每个端口都是h口，会严重影响交换机性能

基于协议的VLAN：基于三层协议，IP、IPX、Apple Talk，而IPX和Apple Talk已被时代淘汰



端口类型：

H3C交换机所有端口默认是access，华为默认是hybrid

access：只能属于一个VLAN，必须加入到一个VLAN ; 从a口发出的帧会撕掉标签，默认所有端口是a口，属于VLAN1

​	收：

​		带标签：检查数据的标签与端口的标签是否相同，相同则接收，否则丢弃

​		不带标签：强制性打上接收数据端口的标签

​	发：剥离标签再发送



trunk：可以允许多个VLAN的数据通过；trunk端口发出的帧不会撕掉标签，默认VLAN除外；收到未打标签的帧，会打上默认VLAN的标签

​	收：
​		带标签：检查数据的标签在端口下是否允许通过，允许则接收，否则丢弃

​		不带标签：强制性打上接收数据端口的标签

​	发：
​		检查数据的标签在端口下是否允许通过，如果不允许，直接丢弃

​		如果允许通过，则检查数据的标签与端口的标签是否相同

​		如果相同，剥离标签在发送，否则携带原有标签转发



hybrid：可以允许多个VLAN的数据通过；可以人为配置哪些VLAN的数据帧撕标签，哪些不撕标签

​	收：

​		带标签        检查数据的标签在端口下是否允许通过，允许则接收，否则丢弃

​		不带标签     强制性打上接收数据端口的标签

​	发：
​		检查数据的标签在端口下是否允许通过，如果不允许，直接丢弃

​		如果允许通过，则检查端口配置是否需要携带标签转发

​		如果需要携带，则携带，否则剥离再转发



### STP

通过把二层网络修剪层树形结构来解决二层环路问题

环路：两台设备之间多于两条路径可走

环路会导致广播风暴、MAC地址表震荡，多帧复制，严重影响网络质量

STP通过选举，临时堵塞一个端口，当其他端口故障时，自动将堵塞的端口打开



STP选举：

1.在整个二层网络中选举一台根桥

​	通过比较BID选举，BID最小的被选举为根桥。BID = 优先级+MAC地址；优先级默认是32768；先比较优先级，再比较MAC地址

​	修改优先级只能是4096的倍数

2.在每台非根网桥上选择一个根端口

​	a.到达根桥开销最小的优先

​	b.流经的上游交换机BID小的优先

​	c. 端口ID小的优先

3.每个物理段上选举一个指定端口

​	a.到达根桥开销最小的优先

​	b.流经的上游交换机BID小的优先

​	c. 端口ID小的优先

4.最后没有角色的端口就是堵塞端口



交换机通过发送BPDU来传递生成树的参选信息

BPDU：桥协议数据单元

hello time：默认2S

max age：默认20S





交换机运行STP的端口状态：

​	disable：接口生成树被收到关闭

​	blocking：堵塞状态；可以接收BPDU，不能发送BPDU；不学习MAC地址；不转发数据

​	listening：监听状态；收发BPDU；不学习MAC地址；不转发数据；持续15秒

​	learning：学习状态；收发BPDU；学习MAC地址；不转发数据；持续15秒

​	forwarding：转发状态；收发BPDU；学习MAC地址；转发数据



STP缺点：拓扑结构发生改变需要重新选举、收敛时间长、浪费链路资源

收敛：网络在不稳定状态向稳定状态的过程



RSTP改进：

1.增加了端口角色：根端口、指定端口、替代端口（根端口的备份）、备份端口（指定端口的备份）

​	当根端口或指定端口故障时，替代端口或备份端口直接顶上，大大缩短收敛时间

2.端口状态减少：discarding、learning、forwarding

3.增加了边缘端口机制：边缘端口不参与生成树选举；边缘端口的状态变化不会触发生成树选举；边缘端口收到BPDU会自动转换成非边缘端口



MSTP：在网络中创建多个生成树，映射到不同的VLAN来实现流量负载均衡



### 交换机认证与端口隔离

IEEE802.1X协议

解决局域网用户的接入认证问题

认证方式

​	本地认证：本地接入交换机对客户端进行认证

​	远程集中认证：远程认证服务器对客户端进行认证

交换机802.1X配置

```
dot1x
int g 1/0/1
dot1x
quit

local-user admin class network
password simple 123456
service-type lan-access
```



端口隔离

实现同一VLAN内端口之间的二层隔离

端口隔离配置

```
port-isolate group 1
int g 1/0/1
port-isolate enable group 1
```



### 链路聚合

两台交换机之间的多条物理链路聚合成一条逻辑链路

实现链路冗余备份

增加链路带宽

基于流实现流量负载均衡



负载均衡两种模式：

​	基于包的模式（思科）

​	基于流的模式（华为、H3C）



分类：

静态：不使用聚合协议来协商链路信息

动态：使用聚合协议来协商链路信息

​	LACP：基于IEEE802.3ad标准的动态链路聚合协议

链路聚合配置

```
int Bridge-Aggregation 1
link-aggregation mode dynamic //设置为动态(LACP)，默认为静态
quit

int g 1/0/1
port link-aggregation group 1
```



### DNS

根据域名查询IP地址；使用TCP和UDP承载流量，端口号53；

FQDN：完全合格域名

域名结构：

​	主机名	二级域名	顶级域名	根域

递归解析：以本地DNS服务器为中心进行解析

迭代解析：以本地DNS客户端为中心进行解析

反向解析：根据IP地址查询域名



### FTP

基于TCP传输

主动模式（PORT）：端口号固定为21和20

被动模式（PASV）：控制端口号21，数据端口号不固定



TFTP

简单FTP，使用UDP承载流量，端口号69



### DHCP

基于UDP传输

服务端端口号：67；客户端端口号68；



主机获取IP地址步骤：

DHCP Discover（广播）

DHCP Offer（单播）

DHCP Request（广播）

DHCP Ack（单播）



DHCP NAK：服务器对request报文的拒绝响应

DCHP Release：客户端要释放地址时用来通知服务器



租期到达50%，客户端会主动续租；到达87.5%时，客户端会再次续租

DHCP配置

```
dhcp enable
dhcp server ip-pool vlan10
network 192.168.10.0 mask 255.255.255.0
gateway-list 192.168.10.1
dns-list 8.8.8.8
forbidden-ip 192.168.10.6 192.168.10.18 //排除地址
expired day 0 hour 0 minute 15 second 0 //设置租约
```

DHCP中继配置

```
dhcp enable
int g 0/0
dhcp select relay
dhcp relay server-address 10.10.10.10
```



### IPv6

IPv4的缺点

​	地址不足

​	终端用户配置不够简便

​	缺乏安全性和QoS支持

IPv6的优点

​	几乎无限的地址空间

​	终端用户无须任何配置

​	设计时就考虑到增强的安全性和QoS



冒号十六进制表示法，128bit

可以缩写：

​	段内前导0压缩

​	全0段压缩

​	连续的几段0，压缩成两个冒号（整个地址只能压缩一次）



IPv6构成：

没有IPv4类的概念

前缀	接口标识符	前缀长度



IPv6通信类型

单播、组播、任播

IPv6没有单独的广播，被认为是组播的一部分

任播（目前没有商用）：去往目的地有多条路，自动找最近的网关



常用类型与格式：

单播

​	未指定地址	::/128

​	环回地址	::1/128

​	链路本地地址	FE80::/10

​	站点本地地址	FEC0::/10

​	全球单播地址	2000::/3

组播

​	FE00::/8

任播

​	单播地址空间中进行分配



IPv6邻居发现协议（ND）

功能包括：

​	地址解析：与IPv4 ARP类似

​	路由器发现/前缀发现：发现网络中的路由器及前缀，有利于自动配置

​	地址自动配置：用于自动生成地址

​	地址重复检测



地址自动配置：通过交互信息来发现路由器及前缀，实现自动配置

​	主机发送路由器请求消息（组播）

​	路由器回应路由器通告信息

​	主机生成全球单播地址

IEEE EUI-64格式：根据MAC地址自动生成接口标识符

MAC地址中间插入FFFE，再设置U/L位（第一个字节，倒数第二位）



生成的单播地址格式：本网段路由器的前缀+接口标识符/路由器前缀长度

生成的链路本地地址格式：FE80::接口标识符/10

```
int g0/0
undo ipv6 nd ra halt //取消ra消息抑制，让接口连接的pc可以自动获取路由器的前缀
```



### IP路由原理

下一跳：数据包从出接口发出后，到达的下一个IP地址



路由表查表规则：

1.路由迭代：如果下一跳的地址是非直连地址，路由器会以该下一跳为目的地址，再次查找路由表，直到查询到下一跳是直连地址为止

2.如果路由表中没有相匹配的路由就会丢弃数据包，如果存在默认路由的话，会从默认路由转发



路由表选路顺序：

1.最长子网掩码匹配

2.最小优先级

3.最小度量值

路由器将最优（Active）路由下载到FIB表，路由器根据FIB表转发



路由表来源：直连、静态、动态

不同的路由来源，拥有不同的优先级



路由表写表规则：

学习到多条路由条目时，先比较优先级，小的先进行加表；

若优先级相同，则比较度量值，仍是小的先进行加表；

若优先级与度量值两者都一样，则同时进行加表，即ECMP（多路径等价路由）



### 直连路由、静态路由

直连路由的建立：接口的物理状态与协议状态双up

VLAN间通信就是采用配置逻辑接口，生成直连路由的方式，通过三层路由转发进行通信

静态路由建立：通过管理员手动配置目的网段和下一跳

默认路由：表示去任意网段的路由

浮动静态路由：配置两条静态路由，默认选取优先级小的作为主路径

黑洞路由：指向null0接口的路由，转发到该接口上的数据包都会被丢掉



### 路由协议概述

路由协议功能：

1.邻居发现

2.路由信息交换

3.路由计算

4.路由信息维护



路由协议分类（根据使用位置分类）：

IGB：内部网关协议

​	运行在自治系统（AS）内部的路由协议

​	自治系统（AS）：统一管理，运行同一个IGP协议的路由器组成的网络范围

​	查询AS网站：www.cidr-report.org

​	AS编号：1-65535；私有AS编号：64512-65535

EGP：外部网关协议

​	运行在自治系统之间的路由协议



路由协议分类（根据路由计算方式分类）：

距离矢量路由协议：度量值是跳数，经过一个路由器算一跳

路径矢量路由协议：度量值是跳数，经过一个AS算一跳

链路状态路由协议：度量值是开销，开销计算：参考带宽/接口带宽\*10；参考带宽：100Mbps



静态路由优点：不消耗系统和网络资源

静态路由缺点：需要管理员手动添加，不能根据拓扑变化而修改路由表

动态路由优点：自动发现路由，能根据拓扑变化而实时修改路由表

动态路由缺点：消耗系统和网络资源



### RIP

IGP、距离矢量路由协议

分成RIPv1和RIPv2；基于UDP传输，端口号520

RIP会把本路由器的路由表通过广播（v2是组播）从所有开启了RIP的接口上发送出去

RIP报文会周期性发送，周期是30S



RIP防环机制：

1.水平分割：从某个接口学习到的路由条目不会再从该接口回传；与毒性逆转不能同时运行，默认开启水平分割

2.毒性逆转：从某个接口学习到的路由条目设置16跳再回传

3.路由毒化：当某条RIP路由失效，不会立即从路由表中删除，而是以16跳的形式通告给邻居

4.抑制计时器：当某条路由失效，并且从另一个接口收到一条比原路由跳数更大的RIP更新，则启动抑制计时器；抑制计时器内，只接受比原路由跳数更低的路由更新

​	更新计时器：30S

​	失效计时器：180S

​	垃圾收集计时器：240S

​	抑制计时器：180S

5.触发更新：当网络结构发生变化，不用等到下个更新周期，立即发送更新

6.最大跳数：RIP支持最大跳数15跳，超过15跳认为不可达



network命令宣告网段的两层含义

1.接口使能：会向该网段所在接口发送RIP协议报文

​	连接PC、交换机的接口发送协议报文，没有任何意义，可以将该接口设置成静默接口，以节约网络资源

2.路由使能：会把该网段的路由信息发送给邻居



RIPv1的缺陷：

协议报文不携带子网掩码（不支持无类地址）按主类地址区分目的网段

不支持认证

只能广播发送协议报文

不能关闭自动汇总，不能手动汇总

RIPv2的改进：

协议报文携带子网掩码（支持VLSM和CIDR）

支持接口MD5和明文认证

通过组播发送协议报文；组播地址：224.0.0.9

可以关闭自动汇总，进行手动汇总



RIP缺陷：

以跳数评估路由并非最优路径

最大跳数15跳导致网络尺度小

收敛速度慢

更新发送全部路由表浪费网络资源

RIP宣告不识别子网掩码，容易照成多余宣告

RIP计算路由的方式容易成环



RFC文档包含了关于Internet的几乎所有重要的文字资料



### OSPF

IGP、链路状态路由协议、使用SPF算法

OSPF直接工作于IP层上，协议号为89

以组播地址发送协议报文；所有运行OSPF的路由器监听224.0.0.5；DR/BDR监听224.0.0.6

RIP与OSPF最大的区别：RIP是直接传路由表给邻居，OSPF是传LSA给邻居，邻居通过SPF算法计算出最优路由



OSPF工作流程：

1.发现并建立邻居和邻接关系，写入邻居表

​	a.以组播的形式发送hello报文来建立邻居关系

​		建立邻居的条件：

​		1）双方接口可以IP连通且都启用了OSPF

​		2）双方接口处于同一个OSPF区域

​	b.通过选举DR/BDR来建立邻接关系

​		1）所有DRother和DR/BDR建立邻接关系

​		2）DR与BDR建立邻接关系

​		3）DRother之间维持邻居关系

2.邻接路由器互相发送链路状态更新，区域内所有路由器实现链路状态数据库（LSDB）同步，LSDB也叫拓扑表

​	a.向邻居路由器发送DD报文，DD报文是本路由器所有LSA的摘要信息

​		LSA：链路状态通告，LSA用来描述某个运行了OSPF的端口详细信息

​	b.对方收到DD报文后，与本机LSDB对比，向对方发送LSR报文，请求对方发送本机所需的LSA详细信息

​	c.收到对方的LSR后，把对方所需的LSA打包成一条LSU报文传递给对方

​	d.收到对方的LSU后，发送LSAck向对方确认接收

3.每台路由器根据LSDB，使用SPF算法分别计算出到达每个目的地的网段的最优路径、写入路由表



DR/BDR的选举：

每个以太网段都要选举一个DR和BDR；DR/BDR是端口角色不是路由器角色；P2P链路不需要选举

选举规则：

1.优先级大的优先，默认是1，最大255，0不参与选举

2.RID大的优先



RID来源：

1.手动配置，配置一个IPv4的地址格式

2.该路由器环回接口上最大的IP地址

3.该路由器接口上最大的IP地址



OSPF报文：

Hello、DD、LSR、LSU、LSAck



OSPF分区域管理

减少LSA的泛洪范围，减少区域内LSDB中的LSA数量，加快路由的收敛速度，降低了运行OSPF对路由器性能的要求

可以将相同功能或地理位置的路由器划分到一个区域便于管理

隔离拓扑变化，减少路由震荡对自治系统的影响（把网络故障隔离在区域内部）



IR：区域内部路由器

ABR：区域边界路由器

ASBR：自治系统边界路由器

骨干区域：只能有一个骨干区域，且骨干区域必须是连续的

​	整个OSPF只有一个区域，骨干区域可以是任何一个编号，如果有多个区域，骨干区域必须是0

非骨干区域：非骨干区域必须与骨干区域相连（防环）



### ACL

基于包过滤的访问控制技术

配置ACL后，数据包对ACL逐条匹配，根据动作丢弃或者放行，如果没有匹配到规则，则按默认规则处理

入站数据包过滤会先在入接口匹配入方向ACL，然后查表转发

出站数据包过滤会先查表转发，然后在出接口匹配出方向ACL

华为、H3C的ACL默认规则是允许，思科默认规则是拒绝

华为、H3C的ACL只有做包过滤时，默认允许，其他情况都默认拒绝



ACL配置的注意事项：

1.不影响实际效果的情况下，建议把包过滤策略应用在离源地址最近的的接口

2.如果默认动作是允许，至少要配一条拒绝规则；如果默认动作是拒绝，至少需要一条允许规则

3.小范围规则放在靠前的位置



ACL分类：

基本ACL：匹配数据包的源地址，编号范围：2000-2999

高级ACL：匹配数据包的源地址、目的地址、源端口、目的端口、协议类型，编号范围：3000-3999

二层ACL



### NAT

IPv4地址不够使用，私有地址不能上互联网

NAT提供私有地址到公有地址的转换



NAT分类：

Static NAT：私网地址与公网地址固定的一对一转换

Basic NAT：N个私网地址与N个公网地址不固定的一对一转换

NAPT：N个私网地址与1个公网地址多对一转换，不同地址流量通过端口号区分

Easy IP：NAPT的一种简易配置方式，通过路由器出接口的公网地址进行转换

NAT Server：公网地址某端口映射到私网地址某端口，适用于公网设备主动请求访问内网设备

NAT ALG：NAT应用层网关，针对多通道协议应用层的地址信息进行转换



### HDLC

用于广域网点到点链路，只支持同步传输

每10S发送一个Keepalive消息，5个周期内无法收到对方发出的Keepalive消息，HDLC就认为链路不可用

两端Keepalive消息轮询时间必须一致



### PPP

支持同步和异步线路

支持身份验证：验证成功才能连入网络

支持地址协商：验证成功后连接双方可以自动协商出IP地址

没有重传机制，网络开销小

PPP只能运行在点到点链路，PPPoE可以运行在以太网上

PPP链路直连两端不在同一网段也能通信



PPP由两个部分组成：

LCP：工作在二层，用来做身份验证

NCP：工作在三层，用来做地址协商



PPP协商过程

1.链路建立和配置协商

2.身份验证（可选）

3.网络层地址协商



PPP会话阶段：

Dead链路不可用阶段

Establish链路建立阶段

Authenticate认证阶段

Network网络层协商阶段

Terminate终止阶段



PPP验证：

PAP

​	密码以明文传送

​	被验证方发起验证请求，两次握手验证

CHAP

​	不发送密码

​	验证方首先发起验证请求，三次握手验证

PAP和CHAP都支持单向和双向验证

双向验证时，双方都需要创建账户，密码需要一致



PPP MP

将多个PPP链路捆绑当一条链路使用

地址配在逻辑接口上，验证还是配置在物理接口上



### WLAN

目前WLAN有两个技术：

Wi-Fi

WAPI（国内强制使用）



WLAN两个频段

2.4G：ISM频段（工业，科学，医疗使用频段）

​	工作频段在2.402GHz-2.4835GHz

​	细分为14个信道，每个信道22MHz，可以划分3个无冲突信道

5G：

频段越高，穿透能力越不好

5个完全无冲突信道



AP：无线接入点

​	FAT-AP：自身拥有管理能力

​	FIT-AP：自身没有管理能力，需要靠AC统一管理

AC：无线控制器

STA：无线接入终端

SSID：服务集标识符

BSS：基本服务集，AP和AP连接的STA

DS：分布式系统

ESS：拓展服务集，通过相同的SSID组成虚拟的BSS
