## H3CSE大规模网络路由技术

### 企业网络模型

基于SOA的网络架构：

应用层

服务层（针对应用层的服务）

基础设施层



IToIP：基于SOA思想的解决方案

优点：

可构筑个性化的解决方案

降低总成本

灵活、高效、快速



层级化网络模型

核心层：高速数据交换

​	对来自汇聚层的数据进行尽可能快速的交换

​	强大的数据交换能力

​	稳定可靠的高冗余设计

​	不配置复杂策略

汇聚层：流量汇聚及复杂的策略控制

​	1.将接入层数据汇集起来，依据策略对数据、信息等实施控制

​	2.必要的冗余设计

​	3.复杂的策略配置，包括路由策略、安全策略、QoS等

接入层：用户接入与接入控制

​	1.为用户提供大量接口

​	2.接入安全控制

​	3.接入速率控制、基于策略的分类、数据包标记等

​	4.较少考虑冗余性



层级化网络模型优点

网络结构清晰

便于规划和维护

增强网络稳定性

增强玩过可扩展性



典型企业网结构：

数据中心（网络结构比较特殊，不采用层级化网络模型）

园区网（多建筑）

大型分支机构（建筑或多楼层）

中型分支机构（楼层或者多办公室）

远程/分布式办公（移动人员）



层级化网络模型与路由协议

核心层：OSPF、IS-IS、BGP

汇聚：OSPF、IS-IS

WAN：BGP、静态路由



大规模网络的路由可靠性需求：

核心层：

​	路由协议路径自动冗余

汇聚层：

​	路由协议路径自动冗余

​	区域划分隔离路由故障

WAN：

​	BGP

​	浮动静态路由



大规模网络的路由可扩展性需求：

支持VLSM，有利于路由聚合

协议分层架构与网络分层相结合

路由度量值符合网络发展需要



大规模网络的路由可管理性需求：

调整路由开销、路由属性和优先级影响协议选路

用路由过滤、路由策略等技术控制路由学习和传播范围

用PBR控制IP数据包的定向转发



路由快速恢复需求：

邻居失效的快速检测

​	快速Hello

​	BFD

路由快速收敛

​	增量路由计算

​	部分路由计算

​	LSP快速扩散

快速重路由技术

​	IP快速重路由

​	MPLS快速重路由



### 路由控制与转发

控制平面：负责路由计算、维护。路由协议运行于控制平面

转发平面：负责报文转发。路由表、FIB表、快速转发表

传统网络中只能通过运行路由协议来控制数据转发

SDN分离控制平面与转发平面，允许管理员直接对转发平面进行编程



路由表：由CPU维护

FIB表：由专用的芯片维护，表项规模小，查询速度快

​	表项来源：

​	来自于路由表中的Active路由

​	来自于ARP生成的网段内部路由

快速转发表：由专用的芯片维护，表项规模非常小，查询速度快，是一张缓存表

​	表项来源：

​	每组流量第一个报文正常查FIB表/路由表，把该报文中的五元组、进出接口记录下来，该组流量的后续报文根据快速转发记录进行转发



### 路由协议基础

距离矢量路由协议特点：

周期性，广播（组播）式发送路由更新

路由更新中携带全部路由表，接收方据此更新自己的路由

超过一定时间接收不到路由更新，则认为路由失效

以到目的地的跳数作为度量值

路由收敛速度慢

采用距离矢量算法，可能导致路由环路



链路状态路由协议特点：

通过Hello报文发现邻居

建立邻接关系后，只发送LSA

根据自己LSDB来计算路由

以到目的地的开销作为度量值

链路状态发生变化时，马上发送LSA到区域内所有路由器

路由收敛速度快

采用SPF算法，无路由自环



路径矢量路由协议特点：

仅仅在邻居刚建立时发送全部路由表

邻居建立后发送增量路由

如果邻居失效，则认为路由失效

丰富的路由属性作为度量值

拓扑变化以逐条的方式扩散

采用机制防止路由环路



各协议负责维护各自的协议路由表



### 路由负载均衡与备份

ECMP（多路径等价路由）：多条不同路由到达同一目的网段

路由备份：通过修改优先级控制路由优选或者备选

当不同来源路由优先级数字一致时，路由器仍然按照优先级的默认排序进行选择



### 路由聚合与CIDR

路由聚合：

1.缩小路由表规模，加快查表速度

2.降低路由更新流量

聚合的前提条件：

1.被聚合的路由网段必须是连续的

2.到达被聚合的所有网段应该是同一个方向



动态路由聚合是在聚合路由发出的路由器上做

静态路由聚合是在去往该目的网段的路由器上做



路由聚合引起环路

可以采用精准聚合、黑洞路由的方式解决聚合引起的环路



### OSPF

OSPF网络类型：

Broadcast：广播网络；以太网默认就是Broadcast；需要选举DR/BDR，以组播形式发送协议报文

NBMA：非广播多路访问；帧中继、ATM、X.25的默认网络是NBMA；需要手动配置邻居关系，需要选举DR和BDR，单播形式发送协议报文

P2MP：点到多点网络；通过给每个成员单播发送的形式来模拟组播发送协议报文；不选举DR/BDR；一般把帧中继改为P2MP

P2P：点到点网络；PPP链路默认网络类型就是P2P；不选举DR/BDR；以组播形式发送协议报文



邻居状态机：
1.两台路由器没有宣告OSPF之前，属于down状态。

2.宣告OSPF后，在收到第一个Hello包后，将邻居的router-id放到自己的Hello包内active neighbor字段发出，此时状态为init。

3、再次收到对方发来的Hello包内active neighbor字段为自己的router-id，状态进入2-way。在init到2-way这个阶段，OSPF判断网络类型是否需要和邻居建立邻接关系，是否要发送DD报文。

4.双方分别发送DD报文，I=1,M=1,MS=1开始选举主从，两台路由器都认为自己是主，此时为exstart状态。

5.确定主从关系之后(router-id大的为主)，从路由器发送DD摘要，I=0,M=0,MS=0，其中M取决于后续是否还有摘要报文。此时从路由器是exchange状态，主路由器是exstart状态

6.主路由器收到DD摘要后，发送LSR，之后发送DD摘要给从路由器，I=0,M=0,MS=1，M取决于后续是否还有摘要报文。此时从路由器是loading状态，主路由器是exchange状态。

7.从路由器收到DD报文后，发送LSR，然后发送DD报文，I=0,M=0,MS=0。这个DD报文没有摘要信息，只为了告诉主路由器摘要交换完毕，且让主路由器从exchange进入loading状态。

8.双方路由器之间更新LSU之后，回复LSAck，进入Full状态。



DD报文头部三个重要字段：

I：表示初始化DD，协商主从，该DD不挟带LSA摘要

M：表示更多的DD，表示后续还有DD报文，携带LSA摘要

MS：表示Master



OSPF开销计算：

通过参考带宽计算cost，cost小于1也按1计算

建议把网络中带宽最高链路的带宽设置为参考带宽



Hello定时器

Broadcast：10S

P2P：10S

NBMA：30S

P2MP：30S

默认邻居Dead时间：四个Hello周期



default-route-advertise always 命令：没有默认路由，强制下发一条默认路由，下一跳指向本机



LSA类型：

OSPF域内路由：一类LSA和二类LSA只在一个区域内部泛洪

1类LSA（Router LSA）：用来描述一个区域内路由器的相关链路信息，只在一个区域内泛洪

​	LS ID：通告路由器的RID

​	Adv rtr：通告路由器的RID

​	Link-type：

​		Transnet：MA/NBMA网络；Link ID：该网段DR的地址；Data：本路由器在该网段的IP地址

​		P2P：P2P/P2MP网络；Link ID：对端路由器的RID；Data：本路由器与对端连接的IP地址

​		StubNet：描述一个P2P/P2MP链路的网段信息；Link ID：该网段的网络号；Data：该网段的子网掩码

​			loopback的网络类型默认是P2P

​		virtual：虚链路；Link ID：邻居的RID；Data：本路由器的接口IP



2类LSA（Network LSA）：用来对区域内的以太网段进行详细描述

​	LS ID：该网段DR的IP地址

​	Adv rtr：该网段DR的RID

​	Attached router：成员路由器



OSPF域间路由

3类LSA（Summary LSA）：描述跨区域的路由信息

​	LS ID：该网段的网络ID

​	Adv rtr：ABR的RID



OSPF域外路由

4类LSA（ASBR-Summary LSA）：用来描述到达某个ASBR的信息

​	LS ID：该ASBR的RID

​	Adv rtr：ABR的RID



5类LSA（ASE LSA）：用来描述在ASBR上引入的路由的信息

​	LS ID：该网段的网络ID

​	Adv rtr：ASBR的RID



特殊区域：

目的是为了减少区域路由器的路由表规模及LSA的数量

骨干区域不能配置为特殊区域



Stub区域：不接收4类、5类LSA，由ABR下发一条3类默认路由到Stub区域；该区域设备性能低下时可以配置为Stub区域；Stub区域不能存在ASBR



Totally Stub区域：不接收3类、4类、5类LSA，由ABR下发一条3类默认路由到Stub区域；该区域设备性能极其低下时可以配置为Totally Stub区域；Totally Stub区域不能存在ASBR



NSSA区域：不接收4类、5类LSA，但区域内存在ASBR，ASBR会把AS外部路由以7类LSA的形式在NSSA区域内部泛洪；NSSA区域的ABR会把7类LSA转换成5类LSA泛洪到其他区域

NSSA区域需要手动下发默认路由，选择在ABR上下发或者在ASBR上下发

一般在ABR上下发

```
nssa default-route-advertise
```



Totally NSSA区域：在NSSA区域的基础上不接收3类LSA，ABR自动下发3类默认路由到Totally NSSA区域

==华为NSSA区域ABR会自动下发7类默认路由，而H3C不会自动下发==



OSPF选路规则：

1.区域内路由

2.区域间路由

3.第一类外部路由

4.第二类外部路由

如果来源一致，则比较cost

跨区域的路由必须经过骨干区域



Type1 extenal：一类外部路由，计算AS内部的cost

Type2 extenal：二类外部路由，不计算AS内部的cost，默认为二类引入



虚连接：

1.解决骨干区域被分割的问题

2.解决非骨干区域与骨干区域无法相连的问题



路由聚合

只能在ABR或者ASBR上做路由聚合

ABR聚合：区域视图下配置

ASBR聚合：协议视图下配置

not-advertise参数代表聚合路由不予发布，一般用来做路由过滤



OSPF安全特性

OSPF报文验证：

​	区域认证：明文、MD5

​	接口认证：明文、MD5



OSPF路由过滤：

filter-policy 2000 import



过滤3类LSA：（在ABR上做）

filter 2000 import

filter 2000 export

abr-summary not-advertise



过滤5/7类LSA：（在ASBR上做）

filter-policy 2000 export

asbr-summary not-advertise



接口过滤3/5/7类LSA（非必要不适用该方式）

ospf database-filter summary acl 2000



### IS-IS

IS-IS最初是ISO为无连接网络协议设计的动态路由协议

IS-IS不止可以工作在IP，还可以工作在IPX、Apple Talk

IETF对IS-IS进行扩充和修改，使它能同时应用在TCP/IP和OSI环境中，称为集成化IS-IS

IGP、链路状态路由协议，使用SPF算法



术语：

IS：中间系统（路由器）

ES：终端系统（PC）

RD：路由域（AS）



OSI路由分级

Level 0路由：ES-IS，类似于ARP

Leve 1路由：同区域IS-IS

Level 2路由：跨区域IS-IS

Level 3路由：跨RD IS-IS



集成化IS-IS分层网络：

阉割L0路由与L3路由，保留L1路由与L2路由

路由器角色：

L1路由器、L2路由器、L1-2路由器



OSPF一个路由器可以是多个区域；而IS-IS一个路由器只能是一个区域

OSPF把区域0设置为骨干区域，所有非骨干区域都要和骨干区域相连；IS-IS只有骨干网的概念，ISIS的所有区域都要和骨干网物理相连

IS-IS骨干网：由多个连续的L2路由器或L1-2路由器组成的路由域



NSAP地址

NSAP长度：8-20个Byte

NSAP由IDP与DSP组成

IDP由AFI与IDI组成、DSP由HO-DSP、SystemID和NSEL三个部分组成

IDP与HO-DSP一起组成区域地址



NET：网络实体名称，即NSEL为00的NSAP地址

区域地址：1-13个字节，标识路由器区域编号

System ID：6个字节，标识设备，必须路由域唯一

NSEL：1个字节，标识网络类型，00表示工作在IP网络

每台IS最多不超过三个NET地址



IS-IS协议报文

IIH：相当于OSPF Hello

LSP：相当于OSPF LSU

CSNP：相当于OSPF DD

PSNP：相当于OSPF LSR和OSPF LSAck



IS-IS报文基于TLV协议封装

扩展性与兼容性更好



IS-IS网络类型：

Broadcast：以太网、令牌环

P2P：PPP、HDLC



邻居关系建立

邻居关系有L1、L2两种；L2邻居关系可以跨区域建立，L1邻居关系不能跨区域建立

默认所有路由器都是L1-2级别

P2P网络上：只要IS能收到对端的P2P IIH报文，认为邻居能够建立

广播网络上：由DIS创建出虚拟的伪节点，每台IS和伪节点建立邻接关系，邻居建立需要三次握手

DIS的作用是创建和更新伪节点，以简化拓扑

Hello Timer：

​	P2P：10S

​	广播：10S；DIS：3.3S



LSDB同步

L1路由器只维护L1的LSP，L2路由器只维护L2的LSP

L1-2路由器分别维护一个L1的LSDB和一个L2的LSDB

L1-2路由器会向区域内下发默认路由指导数据包转发

CSNP包括所有LSP的摘要信息

​	广播网络周期发送

​	P2P网络只在第一次发送



IS-IS开销类型：

narrow：只接受narrow的开销，只发送narrow的开销

wide：只接受wide的开销，只发送wide的开销

narrow-compatible：只发送narrow的开销，可以接受两种类型的开销

wide-compatible：只发送wide的开销，可以接受两种类型的开销

compatible：可以发送两种类型的开销，可以接受两种类型的开销



IS-IS路由聚合

一般在L1-2路由器上做

默认只对L2路由进行聚合

聚合后路由的开销取聚合路由中最小的开销值



路由渗透（路由泄露）

把L2-LSP转换成L1-LSP，解决次优路径问题



### 路由过滤

路由过滤方法

1.过滤协议报文

2.对协议报文携带的链路状态信息进行过滤

3.对计算出的路由结果进行过滤，不阻止LSA的产生与泛洪



路由过滤工具：

静默接口

ACL

prefix-list

filter-policy：过滤策略，只能对路由进行过滤操作

route-policy：路由策略，不仅可以对路由进行过滤，还可以对路由属性进行修改



### 路由策略

route-policy应用：

​	BGP控制路由属性

​	IGB路由引入时控制路由属性

route-policy注意空节点的配置，空节点允许所有未匹配的路由



### 路由引入

从一种协议引入到另一种协议或者同协议不同进程之间引入

在边界路由器上配置

被引入的路由度量值会被重置为默认值：RIP是0；OSPF是1



多路由协议网络规划：

只在必要时使用多路由协议

路由协议的规划：边缘引入到核心；IGP引入到BGP

路由引入点的规划：单边界引入；多边界引入



路由引入可能会导致路由环路，次优路径等问题

路由环路通过引入时打tag方式解决

次优路径通过引入时修改cost方式解决



### PBR

根据用户制定的策略进行路由选择的机制

使路由器不仅能基于目的地址转发，还可以基于其他元素，如源地址、源目端口、报文长度等

被PBR拒绝的数据包，会按照普通路由正常转发，而不是丢弃

PBR在连接源的接口上下发



### BGP

EGP、路径矢量路由协议；负责把路由从一个AS传递到另一个AS，其他AS传递过来的路由在AS内部的扩散要靠IGP

当一条路由传入某个AS，下一跳会变为上个AS的出接口的IP地址；当一条路由在某个AS内部的路由器之间传递时，下一跳不变

基于TCP传输，端口号179，必须手动配置邻居关系

路由携带丰富的属性

只发送增量路由更新；BGP第一次发送完整路由表，后续只发送增量更新

BGP调用路由策略非常灵活



BGP防环：

IBGP：水平分割：从IBGP收到的路由不会在传给IBGP邻居

EBGP：AS_PATH；当一条路由从一个AS传出，会把该AS编号按照从右至左的顺序依次记录在AS_PATH属性中；一个路由器从其他AS收到一条路由通告，会检查本路由器的AS编号是否出现在该路由条目的AS_PATH属性中，如果出现则该路由条目不学习



BGP术语：

BGP发言者：运行BGP的路由器

BGP对等体：BGP邻居

EBGP：跨AS的邻居关系

IBGP：AS内部的邻居关系



BGP路由黑洞：

IBGP在路由传递过程中跨过中间路由器，从而导致了在数据包发送的时候中间的路由器无法收到路由信息，从而导致数据包转发失败的现象



BGP路由黑洞解决方法：

1.把BGP引入到IGP（一般不用）

2.IBGP全互联

3.BGP路由反射器：反射器无视IBGP防环

4.BGP联盟：AS中创建多个子AS，把IBGP邻居变成EBGP邻居



BGP报文：

Open：用于建立BGP对等体的连接关系

Keepalive：维持邻居关系

Update：发送路由更新

Notification：报错报文，用来通告BGP错误；收到该报文会立即中断邻居关系

Route-refresh：用来发送完整的路由表



BGP状态机：

Idle：30S；准备发送TCP三次握手

Connect：做TCP三次握手（如果TCP建立成功了会进入Opensent状态，反之则进入Active状态）

Active：会一直尝试建立TCP连接，成功也会进入Opensent，这里有一个连接重传计时器，如果超时则会返回Connect状态

Opensent：协商参数要一致，（例如AS号指对，router-id不冲突，版本要一致）协商完成之后进入Openconfirm状态

Openconfirm：进入Openconfirm后会像对端发送Keepalive报文，也从对端收到一个Correct Keepalive报文   则进入Established

Established:   BGP对等体建立状态



IBGP邻居建立条件：

1.TCP可达，无需直连

2.建议使用环回口建立邻居关系

3.更新源地址和邻居指定的IP地址要一致



EBGP邻居建立条件：

1.TCP可达，并且直连，可以修改EBGP最大跳数使EBGP非直连建立（一般不用）

2.建议使用物理口建立邻居关系

3.更新源地址和邻居指定的IP地址要一致



BGP的network命令：只有使能路由的功能；BGP会在本机路由表中对宣告的网段进行精确匹配，被匹配的路由条目会被放入BGP路由表并传递给邻居

BGP不生产路由，只是路由的搬运工

BGP只会传递本机正在使用的路由

BGP的network是精确宣告，目的网段和子网掩码必须和路由表中的路由条目完全一致

BGP可以把任意来源的路由进行宣告，而IGP只能宣告直连网段



BGP路由处理流程

从对等体接收路由==>路由过滤和属性设置\==>路由聚合\==>路由优选\==>加入IP路由表\==>发送给对等体

BGP无法产生等价路由，只能通过手动配置来实现到达不同目的网段的负载均衡

如果配置了advertise-rib-active命令，则BGP发布IP路由表中的最优路由，否则发布BGP路由表中的最优路由



BGP13条选路规则：

1.首先丢弃下一跳不可达的路由

2.优选Preferred-value值最大的路由

3.优选本地优先级值最大的路由

4.依次选择network宣告的路由，import-route引入的路由，聚合路由

5.优选AS_PATH最短的路由

6.依次选择ORIGIN属性为IGP、EGP、Incomplete的路由

7.优选MED值最小的路由

8.依次选择从EBGP、联盟EBGP、联盟IBGP、IBGP学来的路由

9.优选下一跳度量值最低的路由

10.优选CLUSTER-LIST长度最短的路由

11.优选ORIGINATOR-ID最小的路由

12.优选RouterID最小的路由器发布的路由

13.优选IP地址最小的对等体发布的路由



BGP属性：

公认必遵属性：所有BGP路由器都可以识别，且必须存在于Update消息中

公认可选属性：所有BGP路由器都可以识别，但不要求必须存在于Update消息中

可选传递属性：不能被所有BGP路由器识别，如果无法识别，可以传递给邻居

可选非传递属性：不能被所有BGP路由器识别，如果无法识别，则丢弃该属性



公认必遵：

AS_PATH：AS路径属性，记录该路由经过的AS编号

​	AS防环

​	路由优选，AS_PATH属性短的优先

​	增加AS_PATH长度控制选路，建议增加已经经过的AS编号，避免触发防环

ORIGIN：起源属性；标识该路由的来源

​	IGP：来自与network宣告或聚合出的路由（i）

​	EGP：来自引入EGP协议（e）

​	incomplete：来自于其他IGP或静态协议（?）

NEXT_HOP：下一跳属性

​	为了防止IBGP邻居收到的路由下一跳不可达，一般建议把传递至IBGP邻居的路由的下一跳变更为自己



公认可选：

LOCAL_PREF：本地优先级，用于在AS内优选到达某一目的地的路由

​	默认值100，越大越优先

​	本地优先级只传递给IBGP邻居，不会传递给EBGP邻居



可选非传递：

MED：多出口鉴别器，区别到达同一邻居AS的多条入口链路

​	默认值：network宣告的路由，默认值是0；引入其他协议的路由，默认值是该路由引入之前的度量值

​	会被传递至IBGP邻居和EBGP邻居，仅在相邻两个AS之间传递

​	默认情况下只对同一个AS的多个EBGP邻居传递的路由对比MED值



可选非传递：

Preferred-value：首选项，用来对不同的邻居发布的相同的目的网段的路由进行优选

​	只对本路由器有效，不随路由传播

​	默认值是0，越大越优先



路由策略在BGP应用场景：

路由引入时调用

对邻居传出或传入的路由调用

宣告路由时调用，不需要配置匹配条件和空节点



AS路径过滤列表：针对路由经过的AS路径设置的匹配条件

使用正则表达式对路由携带的AS路径属性进行匹配

​	^$：表示匹配本地路由

​	.*：表示匹配所有路由

​	^100：匹配最后经过的AS是100开头的路由

​	^100$：精确匹配从AS100始发，未经过其他AS

如果只针对AS路劲列表做过滤，不需要创建路由策略，只需对邻居直接调用该AS路径列表

如果需要对AS路径列表的路由做属性控制，则需要创建路由策略



BGP对等体组：通过把多个拥有相同配置的邻居加到一个组，来简化配置

外部对等体组配置：（一般不用）

```
bgp 100
group xxx external
peer xxx as-number 200
peer 100.1.1.1 group xxx
peer 200.1.1.1 group xxx
address-family ipv4
peer xxx enable
```

内部对等体组配置：

```
bgp 100
group xxx internal
peer 1.1.1.1 group xxx
peer 2.2.2.2 group xxx
peer xxx connect-interface LoopBack 0
address-family ipv4
peer xxx enable
peer xxx next-hop-local
```



BGP路由聚合

自动聚合：自动把路由的子网掩码聚合为主类掩码

​	只能对引入路由进行自动聚合，无法对network宣告或学习来的路由进行聚合

手动聚合：对路由来源没有限制

```
aggregate 172.16.0.0 22 detail-suppressed //如果不加detail-suppressed表示聚合路由与明细路由一起发布
```



BGP反射器：减少IBGP邻居关系数量，打破水平分割

反射规则：

从非客户机收到路由更新，仅反射给客户机

从客户机收到路由更新，反射给所有的客户机和非客户机，除了路由更新始发者

从EBGP对等体收到路由更新，传递给所有邻居

经反射器反射的路由下一跳地址不变



BGP反射器冗余

创建多个反射群：

每个反射群内所有反射器拥有一致的cluster_id；一条路由每经过一个反射群的反射，就会把该反射群的cluster_id按照从右至左的顺序记录在cluster_list属性中

cluster_list用于反射群防环；每台路由反射器在反射该路由前会做出判断，如果本反射群的cluster_id出现在该路由的cluster_list中，则不反射，否则反射

cluster_list用于路由优选，越短越优先

一个反射群内多个反射器：

每个反射器要配置相同的cluster_id

每个反射器会自动生成唯一的originator_id ；该ID用于路由优选，越小越优先；originator_id会根据RID自动生成



BGP联盟

在自然AS内创建子AS，把子AS之间的邻居关系变成伪EBGP邻居，就不会触发IBGP的防环机制，路由也会传递下去

1.子AS内的路由器创建BGP进程时，宣告的AS编号为子AS编号

2每个子AS内的路由器都要配置联盟ID，联盟ID就是真实AS的编号

3和其他子AS建立了邻居关系的路由器需要配置命令∶
	confederation peer-as 对方子AS编号
4.对真实的EBGP邻居来说，不会把内部子AS的信息传递出去，会以联盟ID的身
份传出
5.对子AS之间的伪EBGP邻居也需要变更下一跳为自己



BGP路由衰减：用来解决路由振荡的问题

通过对频繁振荡的路由条目增加惩罚值的方式来避免频繁更新路由表

```
dampening 涨惩罚值的间隔 降惩罚值的间隔 再使用阈值 抑制阈值  惩罚值上限
//默认惩罚值每次增加1000；默认衰减是惩罚值的50%
```



BGP community属性：可选传递属性

internet：可以传递给所有邻居（默认值）

no_export：不能发布到本地AS之外，可以传递给联盟中的其他子AS

no_advertise：不能被传递给任何其他BGP邻居

no_export_subconfed：不能发布到本地AS之外，也不能传递到联盟中的其他子AS

默认情况下不传递团体属性，需要手动开启

```
peer 1.1.1.1 advertise-community //开启团体属性传递
```



### IPv6

ND：邻居发现协议

ND定义了5种ICMPv6报文类型，包括 RS、RA、NS、NA 和 Redirect报文

1.地址解析

​	要获取对方MAC地址时会以组播的形式发送NS报文请求对方告诉我MAC地址；组播地址FF02::1

​	收到NS请求报文后，会以单播形式发送NA报文把本机的MAC地址告诉给对方

​	收到NA报文后，将IP地址与MAC地址的映射写入邻居缓存表

2.邻居不可达检测

​	INCOMPLETE：未完成，代表已经向对方发送了NS，但还未收到NA

​	REACHABLE：可达，已收到对方的NA

​	STALE：失效，REACHABLE下的计时器超时

​	DELAY：延时，STALE状态下有数据报文要发送给对方，但未收到对方可达性的证实消息

​	PROBE：探测，DELAY状态下向对方发送了探测报文，但任未收到对象可达性证实消息；PROBE状态下计时器超时任未收到，则删除该邻居

3.地址重复检测

4.无状态地址自动配置

有状态的地址获取：从DHCP服务器获取地址及相关信息

无状态的地址获取：根据路由器发布的信息自动配置IPv6地址及相关信息

​	PC以组播形式发起RS报文，请求路由器来告知本网段的前缀和前缀长度；组播地址FF02::2

​	路由器收到RS报文后，同样以组播方式回应RA报文，把本网段的前缀和前缀长度通告给PC；组播地址FF02::1

​	PC收到RA报文后，用路由器通告的前缀+接口标识符/路由器通告的前缀长度，自动生成全球单播地址

5.路由器重定向：当网络中有更优的网关，会自动把网关地址重定位到新的网关



FF02::1	只有PC能接收

FF02::2	只有路由器能接收



IPv6路由与IPv4路由一样：直连路由、静态路由、动态路由协议

RIPng：工作机制与RIPv2基本相同

​	使用UDP的521端口；使用组播地址FF02::9；源地址是链路本地地址

OSPFv3

​	使用组播地址FF02::5、FF02::6；源地址是链路本地地址

IPv6-IS-IS

BGP4+



### IPv6过渡技术

双协议栈技术：节点同时启用IPv4与IPv6协议栈

隧道技术：把IPv6封装到IPv4中（目前常用技术）

​	隧道：指的是利用一种网络协议来传输另一种网络协议

协议转换技术：NAT-PT利用NAT进行IPv4地址和IPv6地址的相互转换



6to4自动隧道：

6to4地址格式为2002:ABCD:EFGH:子网号::接口ID/64，其中ABCD:EFGH对应32位全球唯一IPv4地址，用16进制表示

不需要为每条隧道预先配置目的IPv4地址，由系统从6to4地址中读取