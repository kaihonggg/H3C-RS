## H3CSE构建安全优化广域网

### 概述

广域网接入分类：

1.接入到互联网

2.接入到分支机构



接入到互联网：

1.DSL技术

2.以太网接入：EPON，EPCN

3.Cable moden：广电数字机顶盒接入

4.无线接入：WLAN、3G、4G、卫星

5.电力宽带



接入到分支机构

1.专线连接

2.基于互联网连接的VPN



### 以太网接入技术

该技术存在的问题是怎么解决接入用户的身份验证



PPPoE：基于以太网的PPP协议；在以太网链路上传输ppp帧；原理是把ppp帧再次封装为标准的以太网帧

PPPoE流程：

1.discovery阶段：发现对端设备

2.ppp session阶段：进行ppp协商

​	a.身份验证

​	b.IP地址协商



PON：无源光网络

无源：无电源

EPON：以太网无源光网络，在光纤上传输以太网



DSL：以RJ11电话双绞线作为传输介质的传输技术，它通常可以允许语音信号和数据信号同时在一条电话双绞线上传输

DSL技术按照上行和下行的传输速率是否一致，可以分为速率对称型和速率非对称型两种类型

ADSL：非对称用户数字线路，ADSL利用一对双绞线，提供上下行不对称的速率，可以同时传输语音和数据



### VPN概述

VPN∶虚拟专用网，在公共互联网上构建虚拟私有网络；VPN的本质是让私网报文可以在公网上传输



隧道技术：使用一种协议去封装另一种协议

载荷数据：被封装的原始数据

载荷协议：被封装在内层的协议

封装协议：对载荷协议封装的方式

承载协议：用来封装内层协议的外层协议



VPN分类

按工作层次分：

​	2层：L2TP

​	3层：IPsec、GRE

​	4层：SSL

按使用场景分：

​	Site to Site VPN：IPsec、GRE

​	Access VPN：L2TP、SSL



### GRE

优点：

可以用当前最为普通的IP网络作为承载

支持多种协议

支持组播和动态路由协议

配置简单，部署容易



缺点：

点对点隧道

静态配置隧道参数

布署复杂连接关系时代价巨大

缺乏安全性

不能分隔地址空间（只有MPLS VPN能分隔地址空间）



1.lP over lP GRE:使用公网IP头部来封装私网的IP头部

2.传输过程:

​	a.隧道起点私网路由查找

​	b.TUNNEL口进行公网封装

​	c.承载协议(公网头部)路由查找并转发

​	d.公网路由转发

​	e.查找公网路由并解除公网封装

​	f.隧道终点私网路由查找

3.GRE隧道的主备冗余

​	a.主隧道转发数据，备用隧道处于空闲状态

​	b.当前工作的隧道需要开启KEEPALIVE来保活



### 数据安全技术基础

数据安全的四要素：

机密性：通过数据加密解决

完整性：通过数字签名解决

身份验证：通过数字签名解决

不可抵赖：通过数字签名解决



数据加密：

1.可还原算法：可以根据算法反推明文

2.不可还原算法：不能根据算法反推明文



对称加密：加密和解密使用同一把密钥

非对称加密：加密和解密使用不同的密钥；使用公钥加密，就必须使用私钥解密；使用私钥加密，就必须使用公钥解密

1.公钥∶公开发布在网络中的密钥

2.私钥∶单独保存的密钥，不予公开



组合加解密技术

使用非对称加密来保护对称加密的密钥协商过程；使用对称加密来保护数据。



数字签名：

1.数据发送方根据数据的摘要算出一个hash值，使用本端私钥对hash值进行加密

2.数据接收方收到后，会对该数据加密后的hash值使用发送方的公钥进行解密；如果能解密，则确认是对方的真实身份；如果不能，则代表数据发送方的身份是伪造的



如何解决公钥传播的问题？

采用PKI来解决



### IPsec

IPsec体系结构

IPsec工作模式：

1.传输模式：只提供数据保护，不建立隧道

2.隧道模式：既提供数据保护，也提供隧道建立功能，来实现VPN



安全协议：负责保护数据

AH

ESP



密钥管理：

手动配置密钥

通过IKE协商密钥



SA：安全联盟

每个IPsec的SA都是单向的

IPsec SA : IPSEC安全联盟，定义了一套对数据的保护方案，包括协议、算法、密钥

IPsec SA生成的方法:

1.针对每个对象手工配置：配置复杂度高

2.使用lKE自动协商：配置简单



IPsec工作流程：

第一阶段：IKE SA协商，协商出保护第二阶段协商过程的保护方案

第二阶段：IPsec SA协商，协商出保护数据传输的方案



AH

只提供数字签名，不能提供数据加密功能

不能经过NAT



ESP

不仅可以数字签名，也可以提供数据加密

不对最外层的IP头部进行签名，所以可以穿越NAT



IPsec协商端口：UDP 4500

IKE协商端口：UDP 500



IKE协商模式：

主模式：更加安全可靠，通过双方IP地址来标识身份，但是要求双方都是固定IP地址

野蛮模式：使用名称来标识身份，某一端可以是不固定的IP地址，IP地址固定的一端只需使用名称来识别对方身份；IP地址不固定的一端需要使用IP地址来识别对方身份；必须由IP地址不固定的一端主动发起协商



GRE over IPsec

a.先封装GRE，再封装lPsec

b. IPsec policy下发在公网接口

c.IPsec的感兴趣流是tunnel口配置的目的和源

d.必须有到达对端私网的路由指向tunnel口



IPsec over GRE

a.先封装IPsec，再封装GRE

b.IPsec policy下发在tunnel口

c.IPsec的感兴趣流是私网的地址

d.必须有到达对端私网的路由指向tunnel口



### SSL

工作在传输层

SSL服务端使用TCP的443端口提供服务



优势：

兼容性好，借助游览器实现客户端的自动安装和配置

解析应用层协议，进行高细粒度的访问控制



### VPN部署模式

网关模式（双臂模式）：在连接公网的出口设备上部署VPN

a.对数据的管控更加全面

b.出口设备压力非常大

单臂模式：在内网部署VPN

a.可以减轻出口设备压力

b.对数据的管控和保护不够全面



### MPLS

IP转发采用最长匹配，需要多次查表，转发效率低下

当时的路由器采用通用CPU来进行转发处理



使用一个短而定长的标签来封装普通IP报文

兼容性好，可以兼容各种二层和三层网络类型



MPLS网络组成：

LSR：运行MPLS的路由器

Transit LSR：所有接口都在MPLS网络中的LSR

Ingress LSR：入边缘LSR，连接数据流源地址的边缘设备

Egress LSR：出边缘LSR，连接数据流目的地址的边缘设备



FEC，转发等价类：指具有相同目的相同源的一组能够被MPLS转发的数据流

LSP，标签交换路径：一组FEC在MPLS网络中的传输路径

建立LSP：标签由下游分配，按下游到上游的方向进行分发



MPLS标签：封装在二层头部与三层头部之间

LDP，标签分配协议：用来通告标签和建立LSP

标签都是系统随机生成的

16以下为系统保留；3号标签表示这是最后的一个标签



标签转发操作：

入节点收到IP数据包进行压标签，push

传输节点收到MPLS报文进行标签交换，swap

出节点收到MPLS报文进行标签弹出，pop



### BGP MPLS VPN

传统VPN存在的缺陷：

静态隧道可扩展性不强。传统VPN的隧道需要静态建立，随着用户网络规模的扩大，隧道数量规模庞大

VPN维护和管理只能由用户自行完成。因不同的VPN用户，私网地址存在冲突，负责维护和管理公共网络的运营商不能区分用户



MPLS VPN在传统VPN技术基础上解决以下三个重大问题：

实现隧道的动态建立，使用公共隧道

实现私网地址复用，解决本地地址冲突问题

VPN私网路由易于控制



倒数第二跳弹出标签

如果出标签是3，LSR会直接把标签弹出，再发往出节点设备



组网结构：

P：IP/MPLS骨干网的骨干设备

PE：IP/MPLS骨干网的边缘设备

CE：用户边缘设备



MPLS VPN需要解决的问题：

1.同一台PE设备连接的不同私网lP网段复用的问题

2.标识不同用户私网身份的问题：如何控制私网路由传播范围



多VRF技术：用来解决私网地址复用的问题

将一台路由器划分成多个VRF

每个VRF之间互相独立，互不可见，拥有独立的路由表现、端口、路由协议



MP-BGP：

针对BGP增加了两个选非过渡路径属性

MP_ REACH_ NLRI：Multiprotocol Reachable NLRI (多协议可达NLRI)，用于发布可达的路由信息及下一跳信息。

MP_ UNREACH_ NLRI：Multiprotocol Unreachable NLRI (多协议不可达NLRI)，用于撤销不可达的路由信息。



RD：路由区分，用来标识路由更新报文来自于哪一个VRF

RT：路由目标，分为import RT和export RT，用来控制路由传播范围

新增路由通告会携带RT属性，删除路由通告不会携带RT属性



私网标签：数据包进入公网后，会先封装私网标签，再封装用于标签转发的标签；私网标签用来标识该数据包要交给哪个VRF



### QoS

QoS的功能：

1.尽力避免网络拥塞。

2.在不能避免拥塞时对带宽进行有效管理。

3.降低报文丢失率。

4.调控IP网络流量。

5.为特定用户或特定业务提供专用带宽。

6.支撑网络上的实时业务。

7.QoS不能创造带宽，只能使带宽的分配更加合理。



QoS模型：

1.Best Effort模型：尽力而为服务；所有流量平等对待，先入先出，队列满后尾部丢弃

2.DiffServ模型：差分服务；对不同的数据流进行分类，按不同类别进行标记不同优先级，对不同优先级的数据流提供不同服务

​	进入QoS管理范围时对数据流分类、标记

​	在进入节点的出方向或下一跳的入方向对数据流整形、监管

​	在下一跳对不同标记的数据流提供PHB服务

3.IntServ模型：综合服务；对数据流提供连续的跟踪服务



分类：

a.简单分类：按照数据包的IP优先级或DSCP分类

b.复杂分类：按照数据流源和目的地址、源和目的端口、协议、发送端口来分类

分类工具：traffic-classifier



标记：

标记工具：

​	CAR：边界行为，具备测速功能

​	traffic-behavior

IP 优先级：0-7

DSCP：兼容IP优先级，0-63，可以用纯数字或者关键字的方式来表示



测速：使用令牌桶算法对流量进行速度标识

单桶单速：以CIR速率每秒往令牌桶注入令牌，CBS为桶容量；能取走令牌的数据标绿色，不能取走令牌的数据标红色

双桶单速：以CIR速率每秒往C桶注入令牌，C桶满了后，令牌会注入到E桶；取C桶令牌的数据标绿色，取E桶令牌的数据标黄色，不能取走令牌的数据标红色；可有短暂突发流量

双桶双速：以CIR速率往C桶注入令牌，同时以PIR速率往P桶注入令牌；每个数据包会同时在两个桶中取走令牌；同时取走2两个令牌桶令牌的数据标绿色；只能取走P桶令牌的数据标黄色；不能取走令牌的数据标红色；可有持续突发流量



边界行为：

1.流量监管：通过CAR实现

​	CAR：使用令牌桶算法测速，对不同颜色的流量可以采取放行、丢弃、重标记或转入下一监管等级的处理方式，默认绿色和黄色都放行，红色丢弃；会增加丢包率，但会降低传输延迟

2.流量整形：通过GTS实现

​	GTS：使用令牌桶算法测速，绿色放行，黄色重新打回到队列，红色丢弃；降低丢包率，但增加传输延迟

3.接口限速：通过LR实现

​	流量整形把数据打回到GTS自身队列

​	LR把数据打回用户队列



拥塞管理：一种PHB行为，把分类标记好的数据流放入不同队列实现区分服务

1.FIFO：先进先出

2.PQ：根据不同标记把流量分配到top，middle，normal，bottom队列，按照从上到下的顺序优先转发队列报文；能保证优先级高的流量占据绝对带宽；但会造成低优先级流量饿死的可能

3.CQ：根据不同标记把流量分配到1-16号队列，按照队列号依次轮询调度；能保证每组流量都得到一定带宽，但无法保证高优先级流量得到更多带宽

4.WFQ：根据不同标记自动把流量分散到各个队列；根据每个队列报文优先级计算出该队列的发送权重，然后根据该权重依次轮询调度；既可以保证高优先级流量可以占据更多带宽，也可以保证低优先级流量一定的带宽

5.只有在系统紧急队列空的情况下，才会去调用户创建的队列



拥塞避免：

RED：随机早期检测；当队列长度达到门限值后，自动在队列内随机丢弃报文，避免出现拥塞后的tcp全局同步

WRED：对不同标记的流量配置不同的门限值和丢弃概率，实现不同数据流的区分处理

​	最低门限值：队列长度在最低和最高门限值之间，随机丢弃报文

​	最高门限值：队列长度超出最高门限值，后续报文全部丢弃
