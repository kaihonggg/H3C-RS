## H3CSE构建高性能园区网络

### 园区网模型发展历程

核心层：

1.使用三层交换机；三层交换机不受接口数量限制；基于VLANIF实现三层转发，能够接纳更多网段

2.核心层拓扑结构：

​	双机主备互连

​	多机环网互连

​	多机全互连



汇聚层：

1.使用三层交换或者二层交换；视网络规模而定

2.汇聚层拓扑结构：

​	双上行链路



接入层：

1.使用二层交换机

2.接入层拓扑结构：

​	双上行链路



### 园区网技术应用

核心层：

​	MSTP

​	RRPP：只能适用于环状网络；可实现链路高速收敛

​	IRF

​	链路聚合

汇聚层：

​	MSTP

​	Smart-link：只能适用于双上行，可实现链路的快速收敛

​	VRRP

接入层：

​	身份验证

​	流量控制



通过组播实现点到多点传输

​	数据源发送一份数据包

​	链路上传输一份数据包

​	只有数据接收者才会收到数据包

二层组播：IGMP

三层组播：PIM



### VLAN

VLAN匹配顺序：

1.MAC地址VLAN

2.IP子网VLAN

3.协议VLAN

4.端口VLAN



hybrid用来实现多台主机被隔离，但所有主机都可以访问某个设备



MVRP：VLAN动态注册协议，沿着MSTP单向传播到整个网络（V5版本，叫GVRP）

1.normal都可以传速

2.forbidening只传递vlan1和静态VLAN

3.mix只传递动态VLAN

只有在创建某VLAN的交换机上，才能对该VLAN进行删除操作；无法对动态学习的VLAN进行删除

只能同步VLAN信息，不能同步VLAN接口信息



### VLAN扩展技术

Private VLAN：私有VLAN，用来解决接入层VLAN数量不够用的问题

1.Primary VLAN：上行VLAN，连接上层设备的所属VLAN

2.Secondary VLAN：下行VLAN，连接底层终端的所属VLAN

对上层设备来说，下行VLAN是不可见的



Super VLAN

Super VLAN：只建立三层接口，不包含物理端口

Sub VLAN：不配置IP地址，只包含二层接口，Sub VLAN的所属设备和外部进行三层访问以Super VLAN的IP地址作为网关



### VLAN间路由

单臂路由：通过路由器创建子接口，子接口的接口编号与数据对应的VLAN ID不需要一致

​	是通过在三层接口配置Dot1q终结子接口实现的。子接口也是一种三层的逻辑接口。在子接口上配置Dotlq终结功能和IP地址后，设备

会添加相应的MAC表项并置位三层转发标志位，进而实现VLAN间的三层互通。



三层交换：通过交换机创建VLANIF接口，VLANIF接口的接口编号与数据的VLAN ID必须一致

​	VLANIF接口是一种三层的逻辑接口。在VLANIF接口上配置IP地址后，设备会在MAC地址表中添加VLANIF接口的MAC地址+VID表项，

并且为表项的三层转发标志位置位。当报文的目的MAC地址匹配该表项后，会进行三层转发，进而实现VLAN间的三层互通。



### STP

BPDU：桥协议数据单元，用来传递STP的选举信息

分类：

配置BPDU：传递STP计算的所需信息，基于二层组播发送

​	由根桥周期性始发

TCN BPDU：传递网络拓扑变更通告

​	当拓扑发生改变时，下游交换机给根桥发送一个TCN BPDU，根桥收到后向下游发送TC置位配置BPDU，通知下游交换机直接删除MAC地址表项，并进入生成树重新计算状态



### RSTP

端口状态减少：discarding、learning、forwarding

端口角色增加：指定端口、根端口、备份端口、替代端口

BPDU处理：

BPDU变成TYPE2

每台交换机可以主动发送RST BPDU，而不是根桥才能发送



RSTP快速收敛机制

边缘端口：

不参与生成树计算；边缘端口的UP/DOWN不会触发生成树的计算

边缘端口一旦收到BPDU，立即转变为非边缘端口

—般把连接PC的端口手动配置为边缘端口

P/A机制：

a.当某个端口希望进入转发状态，首先会向对端交换机发起一个proposal报文

b.对端交换机收到proposal报文后，会进行同步操作；同步是指把所有除了收到proposal报文的端口、边缘端口和已闭塞端口之外的所有

端口临时闭塞；同步操作的目的是为了防止临时环路

c.同步完成后，向对端回复一个agreement报文

d.对端收到agreement报文后，才会把该端口进入转发状态

e.被同步操作临时闭塞端口再继续向后进行P/A协商，直到整个拓扑收敛



拓扑变更处理机制

只有非边缘端口状态发生改变时，产生拓扑改变

在两倍Hello时间内向所有其它指定端口和根端口发送TC置位BPDU报文，清除除接收到TC报文的端口之外的所有指定端口和根端口学习的MAC地址，并进入P/A协商



RSTP与STP兼容

连续三次收到STP的BPDU，则端口协议切换到STP



### MSTP

IST：每个域独立计算的生成树结构

CST：每个域当一台交换机，计算出整体的生成树

CIST=CST+每个域IST

CIST域根：每个域的根桥

CIST总根：整个CIST的根桥

Master端口∶计算CST时，以域为单位选出的根端口；单域MSTP中不可能存在Master端口；多域MSTP中，根域不可能存在Master端口，其他域只有一个Master端口



每个MST域内有三个参数保持一致：

域名；修订级别；VLAN与实例的映射关系



MSTP兼容性配置：

```
stp compliance {auto|dot1s|legacy}	//配置端口识别/发送MSTP报文格式
```



### STP保护机制

BPDU保护：解决当一个边缘端口收到一个BPDU时，会变为非边缘端口，重新参与生成树的计算

根保护：解决当网络中出现优先级更高的网桥时，根网桥可能会发生变化，导致闭塞端口发生变化，导致网络流量路径的转变

环路保护：解决由于网络拥塞，在老化时间内，下游交换机没有收到上游交换机的配置BPDU，，则会开启闭塞口，可能会导致临时环路

TC保护：解决交换机收到TC置位的BPDU时，会删除除接收接口外的所有指定端口MAC地址记录，立即进行生成树的计算



### 高可靠性技术

HA：高可靠性

MTBF ：平均无故障时间MTTR:平均故障修复时间

可靠性=MTBF/ ( MTBF+MTTR )

可靠性：

​	5个9标准：年故障时间不超过5分钟可靠性

​	6个9标准：年故障时间不超过30秒



链路备份技术：链路聚合、RRPP、Smart Link

设备备份技术：设备自身的备份技术、VRRP

堆叠技术：IRF



### 链路聚合

端口第一类配置：不参与操作key计算的配置信息;MVRP、MSTP等

端口第二类配置：参与操作key计算的配置信息；VLAN配置；端口类型；QinQ ；

参考端口∶在聚合组里的所有成员端口中选举出一个参考端口，把参考端口的第二类配置生成操作key

操作key：聚合组里的所有成员端口的第二类配置必须和操作key一致才能开启

聚合成员端口状态:

​	Selected:开启转发的状态

​	Unselected :不转发数据的关闭状态



参考端口选举:

静态聚合∶

高速全双工>高速半双工>低速全双工>低速半双工ii；端口ID小的优先

动态聚合：

通过LACP协议来交互第二类配置信息

设备ID小的优先；设备ID=LACP优先级+设备MAC地址

聚合端口ID小的优先:端口ID=端口优先级+端口ID

LACP优先级和端口优先级默认都是32768



### Smart Link

华为，H3C私有技术

针对双上行组网的解决方案

实现主备链路的冗余备份，收敛速度可以达到亚秒级



Smart Link组：一个组只能包含2个端口；主端口和从端口

Master Port：默认处于转发状态

Slave Port：默认处于闭塞状态；当主端口故障，从端口会立即开启

保护VLAN：某个Smart Link组允许通过的VLAN流量；配置时以MSTP实例来实现

控制VLAN：Flush报文转发的VLAN

Flush报文：当链路发生故障切换时，主动向上游交换机发送flush报文；收到flush报文的交换机，会立即在收到该报文的端口重新学MAC地址



Smart Link、生成树、RRPP三者互斥

配置Smart Link的端口上需要关闭生成树

Smart-Link角色抢占模式：默认情况下，当主端口恢复，并不会发生角色抢占，可以通过配置使主端口抢占端口角色



### Monitor Link

用来向smart-link通告上行链路的存活状态；在smart-link的直连上游交换机上配置

Monitor-link组：包含若干上行端口和下行端口

上行端口：连接上层设备的端口

下行端口：连接smart-link的端口

工作机制：

​	当所有上行端口down，强制关闭下行端口

​	任意一个上行端口UP，开启下行端口



### RRPP

华为，H3C私有技术

快速以太环网保护协议；在核心层环网结构中使用的一种快速收敛技术

RRPP域：共同运行同一个RRPP协议的网络

主环：一般把核心层的环设置为主环；主环和子环的健康状态检测都是在主环上完成的

子环：一般把汇聚或接入的环设置为子环

节点：所有运行RRPP的交换机

​	主节点：负责环网的健康检测；主节点上的主端口转发，副端口闭塞

​	传输节点：除主节点外的所有节点；传输节点上的主端口与副端口都是转发状态

​	边缘节点：子环上与主环相交的节点；负责发出子环健康状态检测报文

​	辅助边缘节点：子环上与主环相交的节点；负责接收子环健康状态检测报文

端口：

​	主端口：主节点上的主端口周期性发送hello报文；传输节点上的主端口与副端口没有区别，中转hello报文

​	副端口：主节点上副端口通过接收hello报文判断环网健康状态

​	边缘端口：边缘节点和辅助边缘节点上连接子环的端口

​	公共端口：边缘节点和辅助边缘节点上连接主环的端口

保护VLAN与控制VLAN的概念与Smart Link一致



RRPP工作机制：

Polling机制：主节点的主端口周期性发送hello报文；传输节点会中转该报文；正常情况下，该报文会周期性被主节点副端口收到；如果副端口超过周期没收到hello报文，则判断环网出现故障，会立即开启副端口

链路状态变化通知机制：当环网出现故障，故障所在节点会立即向主节点发送link-down报文来通告网络故障；主节点收到link-down报文后，立即开启副端口

子环健康状态检测机制：子环主节点的主端口周期性发送hello报文，hello会分别沿主环链路和子环、主环相交的链路转发，只有当两条链路都故障才会导致子环主节点副端口无法收到hello报文，从而判断子环故障，开启副端口



主环上子环协议报文通道状态检测机制：

边缘节点周期性沿主环链路发送edge-hello报文；该报文会被辅助边缘节点收到

当主环链路和主环/子环相交的链路同时发生故障，会造成辅助边缘节点无法收到edge-hello报文；辅助边缘节点在无法收到该报文情况下，会立即沿子环链路发送major-fault报文

当边缘节点收到major-fault报文后，会立即把所有边缘端口闭塞

当所有边缘端口闭塞完成后，子环主节点才会开启副端口

该机制会造成部分核心设备成为孤岛设备，但不影响整个园区网络的正常运转



### VRRP

VRRP协议报文使用组播地址224.0.0.18发送

一个VRRP备份组会选举一个主网关和若干个备份网关

优先级大的优先；默认100

IP地址大的优先

如果备份组中某台路由器的真实IP和虚拟网关的IP一致，则该路由器优先级自动变为255，成为主网关

虚拟MAC地址：0000-5E00-01[vrid]

VRRP默认工作在抢占模式：当备份组中出现优先级更高的路由器，主网关会自动发生变化



VRRPv2协议报文

Master路由器定时发送VRRP报文



VRRP状态机

Initialize

Master

Backup：连续3个周期没收到协议报文+抢占延时，或报文携带优先级小于本地优先级，且抢占模式为True，则切换为Master



### IRF

IRF∶智能弹性架构，H3C的堆叠技术；是一种N:1的虚拟化技术；通过把多台交换机虚拟成一台逻辑设备来提高设备的可靠性和性能

IRF的优势︰

1.大幅简化配置管理

2.提高整体设备性能

3.设备扩展简便

4.具有链路冗余和设备冗余的共同优点

IRF工作流程∶

1.通过向所有堆叠口发送hello报文来收集堆叠组的拓扑信息

2.选举Master设备；选举失败的设备会自动重启，重启完成后成为Slave设备

Master设备选举：

1.优先级数字小的优先，默认是1

2.成员设备的设备ID小的优先；设备ID需要手动配置

IRF形成的前提条件:

1.堆叠口对应的物理接口必须是10000M以上的接口

2.一台设备上最多存在2个堆叠口

3.1号堆暑必而连接到另一台设备的2号堆暑口

4.一台设备上2号堆叠口对应的物理口的ID必须大于1号堆叠口对应的物理口的ID



IRF配置步骤：

1.更改设备ID

2.保存配置，重启设备

3.手动关闭物理端口

4.创建堆叠口，加入物理端口

5.手动开启物理口

6.保存配置

7.激活IRF



### 组播概述

点到多点传输



组播的优点：

增强效率，控制网络流量，减少服务器和cpu负载

优化性能，消除流量冗余

分布式应用，使多点传输成为可能

组播的缺点：

无拥塞控制

数据包重复

数据包的无序交付



组播技术需求

1.如何标识接收者（通过组播地址来标识）

2.组播转发路径如何建立（通过组播路由协议PIM来实现）

3.如何维护组信息（通过IGMP协议来实现）

4.组播数据如何转发（通过组播路由协议PIM来实现）

5.终端如何加入/离开组（通过IGMP协议来实现）



组播地址

范围：224.0.0.0-239.255.255.255

本地协议预留组播地址：224.0.0.0-224.0.1.255

本地管理组地址：239.0.0.0-239.255.255.255

用户组播地址：224.0.2.0-238.255.255.255

组播MAC地址：01-00-5e-XX-XX-XX

组播IP地址到组播MAC地址的映射：

把组播IP地址的后23位，直接挪到组播MAC地址的后23位

由于只映射23位，所以会造成部分组播IP地址对应的组播MAC地址是重复的



组播模型：

1.ASM：任意组播源；不区分组播源，共享同一个组播信息表

2.SSM：指定组播源；区分不同的组播源，每个组播维护独立的组播信息表



### IGMP

IGMP：组播组管理协议

主机通过IGMP协议加入和离开组播组

网管设备通过IGMP协议维护本地组播组信息表



工作机制：

主机加入和离开组播组

路由器维护组播组

查询器（DR）选举机制

成员报告抑制机制



IGMPv1：不支持SSM，只支持ASM

1.主机加入：

​	路由器向开启了IGMP的端口发送查询报文，询问该接口下有没有组播接收者

​	收到查询报文的主机，如果希望收某个组的组播，则向路由器回复report报文，把希望加入的组播地址通告给路由器；如果不希望接收组播，则不回复

​	收到report报文后，路由器就会在本地建立组播组信息表，记录该组的（*，G）表项，后续将会转发该组播

2.主机离开：默默离开；当路由器在后续查询报文中没有收到某个组的report报文时，路由器将会把该组的（*，G）表项删除，不再转发该组播

3.IGMPv1没有查询器选举机制，只能依靠上层组播路由协议选举

4.成员报告抑制机制：主机以组播224.0.0.1的地址发送report报文，该报文也会发送至其他主机；收到该report报文的主机会启动计时器（10S）；在该计时器内，如果本机也希望加入该组播组，不会再次发送report报文

5.主机希望加入某个组播组，不用等到路由器发送查询报文，会直接向路由器发送report报文



IGMPv2：支持SSM，支持ASM

1.主机加入：路由器会周期性向开启了IGMP的接口发送普遍查询报文；其他和IGMPv1一致

2.主机离开:

a.主机主动向路由器发送leave报文，通告希望离开的组播组地址

b.路由器收到leave报文后，会发送指定组查询报文，询问该网段内是否还有主机希望接收该组的组播

c.如网段内还有该组接收者，则该接收者会向路由器回复membership-report报文，通告路由器本机还希望接收该组播；如果不希望接收该组播，则不回复

d.如接收到membership-report报文，则不对组播组信息表做任何操作；如没有接收到任何报文，则删除该组播组信息

3.查询器选举：自动选举，IP地址小的优先



IGMPv3：支持SSM，支持ASM

1.主机上维护的组播信息：主机通过发送membership-report报文向路由器通告本机当前组播信息状态、过滤模式变化、源列表变化

2.路由器维护的组播信息：

​	组状态：（组地址、定时器、过滤模式、源列表）

​	源列表：（源地址、源定时器）

3.主机加入：

​	a.路由器发送普遍查询报文

​	b.收到普遍查询报文的主机，如果希望加入某个组播组，就会发送membership-report报文；报文格式包含组地址、源过滤模式、源列表

​	c.路由器收到report报文后，会更具报文的汇总信息，生成相应的组播信息表项

4.主机离开：

​	a.离开某个组播源

​	主动向路由器发送membership-report报文、报文会包含希望变更的组播地址、离开的源地址

​	路由器收到该报文后，会发送指定组查询报文，询问是否还有其他主机希望继续接收该组播源在该组播地址发送的组播

​	如果收到回复，路由器则在组状态中删除该组播源；如果未收到，则不做任何操作

​	b.离开某个组播组

​	主动向路由器发送membership-report报文；报文包含希望离开的组播组和TO_IN(NULL)消息

​	路由器收到该报文，会发送指定组查询报文，询问是否还有其他主机希望继续接收到该组播

​	如果收到回复，路由器则删除该组播组的信息记录，如果未收到则不做任何操作

5.取消了成员报告抑制机制



IGMP Snooping

组播数据在二层按照转发表项发送给组播接收者

不同VLAN的主机点播同一组组播数据时，路由器需要为每个VLAN复制组播报文

组播VLAN的功能：路由器只在组播VLAN内复制数据，减轻路由器负担，并节省网络带宽



### 组播转发机制

组播分发树：组播在路由器上的转发路径，由组播路由协议建立

根据树根位置的不同，组播分发树模型分为

​	1.最短路径树模型（SPT）：路由器为每个组播源分别建立一条到达接受者的最短路径；优点是能保证组播转发延迟；缺点是需要消耗大量系统资源来维护大量组播路径

​	2.共享树模型（RPT）：建立一条所有组播源到所有接受者的共享路径；优点是路由器只需要维护少量的组播路径；缺点是无法保证每个组播源到每个接收者的路径是最短路径



组播转发机制（RPF机制）：逆向路径转发；单播转发关心报文到哪里去，组播转发关心报文从哪里来

工作机制：

组播数据包到达路由器后，执行RPF检查

如果数据包是在到达组播源的最优路径上到达，则RPF检查成功，数据包被转发

如果RPF检查失败，则丢弃数据包

RPF检查基于单播路由表，如果单播路由表存在等价路由，则RPT选择下一跳IP地址大的路由



### 组播路由协议

常见组播路由协议：

DVMRP：RIP组播版本，要求单播使用RIP

MOSPF：OSPF组播版本，要求单播使用OSPFv2

MP-BGP：BGP的扩展

PIM：对单播路由来源无要求



PIM-DM：PIM密集模式，适用于小规模组播网络

假定网络中组播接收者较多，且分布于大部分设备上，采用推的方式分发组播数据

工作流程：邻居发现、扩散、剪枝、状态刷新、嫁接阶段、Assert机制

邻居发现机制：PIM路由器之间周期性发送Hello报文来发现、建立和维护邻居关系，如网段中IGMP版本是v1，则Hello报文可以选举查询器



PIM-SM：PIM稀疏模式，适用于任何规模的网络

采取拉的方式，根据接收者的需求，在组播接收者和组播源之问建立组播分发树

无论网段中的IGMP协议是什么版本，都通过Hello报文选举查询器

工作流程：邻居发现、DR选举、RP发现、加入、剪枝、注册、SPT切换

邻居发现机制：与PIM-DM相同



PIM-SSM

组播接收者通过IGMPv3感知到组播源地址

接收者一侧DR向组播源发起Join报文，建立SPT



### AAA

认证、授权、计费

验证模式：

1.本地验证模式∶用户身份验证过程发生在接入设备上

2.远程验证模式∶用户身份验证过程发生在指定的远程AAA服务器上

RADIUS协议

​	a.使用UDP传输，1812和1813协议

​	b.认证和授权是发生在同一台服务器上

TACACS+协议

​	a.比RADIUS的安全级别更高

​	b.认证、授权、计费彼此独立



### 端口接入控制

802.1X

端口接入控制方式：

1.基于端口：该端口下只要一台客户端通过验证，则该端口下连接的所有客户端都能访问网络；只要一台客户端中断连接，该端口下的所有客户端都会中断

2.基于MAC：一个端口下所有客户端都保留独立的连接，彼此互不影响



MAC地址认证

不需要用户安装任何客户端软件，也不需要用户手动输入用户名或者密码

用户名格式：MAC地址做用户名、普通用户名

支持GUEST VLAN和DYNAMIC VLAN



端口安全

配置端口可以学习的MAC地址最大数量

NeedToKnow特性：检查数据帧的目的MAC地址，目的MAC地址未通过验证，则丢弃数据帧

入侵检测：检查数据帧的源MAC地址，源MAC地址未通过验证则做出相应的惩罚措施



### 网络访问控制

EAD：端点准入防御（H3C私有）

Portal认证：也称为WEB认证，是一种运营商常用的，强制用户到门户网站认证的方式



### 园区网管理

SNMP：简单网络管理协议



镜像技术：把端口的流量复制原封不动发给其他端口

包括端口镜像和流镜像

端口镜像包括本地端口镜像和远程端口镜像



LLDP：用于跨厂商设备之间相互发现各自的设备参数，设备性能，相关配置信息



NTP：网络时间协议



